@using System.Collections.Generic
@model SIGECES.Models.Course

@{
    ViewData["Title"] = $"Estudiantes de {Model.Title}";
    int totalLessons = ViewBag.TotalLessons ?? 0;
    var completedDict = ViewBag.CompletedByStudent as IDictionary<int, int>
                        ?? new Dictionary<int, int>();
}

<div class="page-header d-print-none mb-3">
    <div class="row align-items-center">
        <div class="col">
            <div class="page-pretitle">
                Cursos
            </div>
            <h2 class="page-title">
                Estudiantes de "@Model.Title"
            </h2>
            <div class="text-muted small">
                Categoría: @Model.Category?.Name · Instructor: @Model.Instructor?.FullName
            </div>
        </div>
        <div class="col-auto ms-auto d-print-none">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="ti ti-arrow-left me-1"></i>
                Volver a cursos
            </a>
        </div>
    </div>
</div>

@* Mensajes de éxito / error *@
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="ti ti-check me-1"></i>
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="ti ti-alert-circle me-1"></i>
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
}

<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title mb-0">
            <i class="ti ti-user-plus me-1"></i>
            Agregar estudiante al curso
        </h3>
    </div>
    <div class="card-body">
        <form asp-action="AddEnrollment" method="post" class="row g-2">
            @Html.AntiForgeryToken()
            <input type="hidden" name="courseId" value="@Model.Id" />

            <div class="col-md-6">
                <label class="form-label">Correo del estudiante</label>
                <input type="email"
                       name="studentEmail"
                       class="form-control"
                       placeholder="ej: estudiante@utec.edu"
                       required />
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100">
                    <i class="ti ti-user-plus me-1"></i>
                    Inscribir
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title mb-0">
            Estudiantes inscritos
        </h3>
    </div>

    <div class="card-body p-0">
        @if (Model.Enrollments == null || !Model.Enrollments.Any())
        {
            <div class="p-4 text-center text-muted">
                No hay estudiantes inscritos aún.
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table card-table table-vcenter table-striped table-hover mb-0 js-datatable-course-students">

                    <thead>
                        <tr>
                            <th>Estudiante</th>
                            <th>Correo</th>
                            <th>Fecha inscripción</th>
                            <th>Progreso</th>
                            <th>Estado</th>
                            <th class="w-1"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var e in Model.Enrollments.OrderBy(x => x.Student!.FullName))
                        {
                            <tr>
                                <td>@e.Student!.FullName</td>
                                <td class="text-muted">@e.Student!.Email</td>
                                <td>@e.EnrolledAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                                <td>
                                    @{
                                        int completed = completedDict.ContainsKey(e.StudentId)
                                        ? completedDict[e.StudentId]
                                        : 0;

                                        int percent = totalLessons == 0
                                        ? 0
                                        : (completed * 100 / totalLessons);
                                    }

                                    <div class="d-flex align-items-center">
                                        <div class="flex-fill me-2">
                                            <div class="progress progress-sm">
                                                <div class="progress-bar bg-success"
                                                     role="progressbar"
                                                     style="width:@percent%"></div>
                                            </div>
                                        </div>
                                        <span class="text-muted small">
                                            @completed / @totalLessons (@percent%)
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <form asp-action="UpdateEnrollmentStatus"
                                          method="post"
                                          class="d-flex"
                                          data-enrollment-status-form="true">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="enrollmentId" value="@e.Id" />

                                        <select name="status" class="form-select form-select-sm me-2">
                                            @if (e.Status == EnrollmentStatus.InProgress)
                                            {
                                                <option value="1" selected="selected">En progreso</option>
                                                <option value="2">Completado</option>
                                            }
                                            else
                                            {
                                                <option value="1">En progreso</option>
                                                <option value="2" selected="selected">Completado</option>
                                            }
                                        </select>

                                        <button type="submit" class="btn btn-sm btn-primary">
                                            <i class="ti ti-device-floppy me-1"></i>
                                            Guardar
                                        </button>
                                    </form>
                                </td>
                                <td class="text-end">
                                    <form asp-action="RemoveEnrollment" method="post"
                                          data-confirm="¿Quitar a este estudiante del curso?">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="enrollmentId" value="@e.Id" />
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="ti ti-user-minus me-1"></i>
                                            Quitar
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(function () {
            // Inicializar DataTable para la tabla de estudiantes
            var table = $('.js-datatable-course-students').DataTable({
                columnDefs: [
                    { orderable: false, searchable: false, targets: -1 } // columna acciones
                ]
            });

            // Confirmación SOLO cuando se marca como "Completado"
            $('form[data-enrollment-status-form="true"]').on('submit', function (e) {
                var $form = $(this);
                var selected = $form.find('select[name="status"]').val();

                // 2 = EnrollmentStatus.Completed
                if (selected === '2') {
                    e.preventDefault();

                    Swal.fire({
                        title: 'Marcar curso como completado',
                        text: '¿Estás seguro de marcar este curso como completado para este estudiante? ' +
                              'Se marcarán todas las lecciones como completadas.',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, marcar como completado',
                        cancelButtonText: 'Cancelar'
                    }).then(function (result) {
                        if (result.isConfirmed) {
                            // Desenganchamos el handler para evitar bucle y enviamos de verdad
                            $form.off('submit');
                            $form.submit();
                        }
                    });
                }
                // Si no es "Completado", dejamos pasar el submit normal
            });
        });
    </script>
}
